name: Deploy To EC2 (Blue-Green Public)

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Create firebase.json
        run: |
          cat << 'EOF' > ./src/main/resources/petbulance-b316f-firebase-adminsdk-fbsvc-8c92a7aab5.json
          ${{ secrets.FILEBASE_JSON }}
          EOF

      - name: Create application.yml
        run: echo "${{ secrets.APPLICATION_PROPERTIES }}" > ./src/main/resources/application.yml

      - name: Build Spring Boot
        run: |
          chmod +x ./gradlew
          ./gradlew clean build -x test

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ap-northeast-2
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Login to ECR
        run: |
          aws ecr get-login-password --region ap-northeast-2 \
            | docker login --username AWS --password-stdin 276995858259.dkr.ecr.ap-northeast-2.amazonaws.com

      - name: Build & Push Docker Image
        run: |
          docker build -t petbulance .
          docker tag petbulance:latest 276995858259.dkr.ecr.ap-northeast-2.amazonaws.com/petbulance:latest
          docker push 276995858259.dkr.ecr.ap-northeast-2.amazonaws.com/petbulance:latest

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          cat <<EOF >> ~/.ssh/config
          Host ec2-server
            HostName ${{ secrets.EC2_PUBLIC_IP }}
            User ubuntu
            IdentityFile ~/.ssh/id_rsa
            StrictHostKeyChecking no
          EOF

      - name: Blue-Green Deploy via SSH
        run: |
          ssh ec2-server << 'EOF'
            set -e

            echo "▶ Nginx 환경 설정 확인"
            if [ ! -f /etc/nginx/conf.d/service-env.inc ]; then
              echo "set \$service_url blue;" | sudo tee /etc/nginx/conf.d/service-env.inc
            fi
            
            CURRENT_VAL=$(grep -oP '(?<=set \$service_url ).*(?=;)' /etc/nginx/conf.d/service-env.inc || echo "blue")
            
            if [ "$CURRENT_VAL" = "blue" ]; then
              TARGET="green"
              TARGET_PORT=8081
              OLD_TARGET="blue"
            else
              TARGET="blue"
              TARGET_PORT=8080
              OLD_TARGET="green"
            fi
            
            echo "▶ 신규 배포 대상: $TARGET (포트: $TARGET_PORT)"
            
            # ECR 로그인
            aws ecr get-login-password --region ap-northeast-2 \
              | docker login --username AWS --password-stdin 276995858259.dkr.ecr.ap-northeast-2.amazonaws.com
            
            echo "▶ 사전 이미지 및 컨테이너 정리 (용량 확보)"
            docker image prune -af || true
            
            echo "▶ 최신 이미지 Pull"
            docker pull 276995858259.dkr.ecr.ap-northeast-2.amazonaws.com/petbulance:latest
            
            echo "▶ 기존 $TARGET 컨테이너 제거"
            docker stop $TARGET || true
            docker rm $TARGET || true
            
            echo "▶ $TARGET 컨테이너 실행 (리소스 제한 추가)"
            docker run -d \
              --name $TARGET \
              --restart=always \
              --memory="1g" \
              -e SPRING_PROFILES_ACTIVE=$TARGET \
              -e JAVA_TOOL_OPTIONS="-Duser.timezone=Asia/Seoul -Xms512m -Xmx750m" \
              -e SPRING_DATA_REDIS_HOST=172.17.0.1 \
              -e SPRING_DATA_REDIS_PORT=6379 \
              -p $TARGET_PORT:8080 \
              276995858259.dkr.ecr.ap-northeast-2.amazonaws.com/petbulance:latest
            
            echo "▶ 헬스 체크 시작 (/app/health)"
            HEALTH_OK=false
            for i in {1..50}; do
              if curl -sf http://localhost:$TARGET_PORT/app/health; then
                echo "✅ 헬스 체크 성공!"
                HEALTH_OK=true
                break
              fi
              echo "대기 중... ($i/50)"
              sleep 5
            done
            
            if [ "$HEALTH_OK" != "true" ]; then
              echo "❌ 헬스 체크 실패. 로그를 출력하고 중단합니다."
              docker logs $TARGET
              exit 1
            fi
            
            echo "▶ Nginx 스위칭"
            echo "set \$service_url $TARGET;" | sudo tee /etc/nginx/conf.d/service-env.inc
            sudo nginx -t && sudo nginx -s reload
            
            echo "▶ 이전 컨테이너($OLD_TARGET) 정리"
            docker stop $OLD_TARGET || true
            docker rm $OLD_TARGET || true
            docker image prune -af
            
            echo "✅ 배포 완료! 현재 실행 중: $TARGET"
          EOF
